<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chemistry Reaction Explorer | Professional Tools</title>
  <!-- 3DMol.js for molecule visualization -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/3Dmol/1.2.0/3Dmol-min.js"></script>
  <!-- JSME for molecular structure input -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsme/2017.02.26/jsme/jsme.nocache.js"></script>
  <style>
    /* Previous styles remain, adding new ones for professional tools */
    .jsme-container {
      width: 100%;
      height: 300px;
      border: 1px solid #ddd;
      margin: 15px 0;
    }
    .advanced-tool {
      background: #f0f8ff;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
    }
    .loading {
      color: #007acc;
      font-style: italic;
    }
  </style>
</head>
<body>

<!-- Previous header and container remain -->

<div class="container">
  <div class="tool-container">
    <h2>Professional Chemistry Tools</h2>
    
    <!-- Enhanced Equation Balancer with ChemBalancer API -->
    <div class="advanced-tool">
      <h3>Professional Equation Balancer</h3>
      <input type="text" id="proUnbalancedEquation" placeholder="Enter unbalanced equation (e.g., C6H12O6 + O2 → CO2 + H2O)">
      <button onclick="balanceWithAPI()">Balance Professionally</button>
      <div id="apiBalancingSteps" class="calculation-result"></div>
      <div id="apiBalancedEquation" style="font-size: 1.5em; margin: 15px 0;"></div>
      <div id="proMoleculeViewer" class="molecule-canvas"></div>
    </div>
    
    <!-- Enhanced Reaction Simulator with JSME -->
    <div class="advanced-tool">
      <h3>Molecular Structure Builder</h3>
      <div id="jsme-container" class="jsme-container"></div>
      <button onclick="getJSMEStructure()">Get Structure</button>
      <div id="jsmeOutput"></div>
      <button onclick="addToSimulator()">Add to Reaction Simulator</button>
    </div>
    
    <!-- Enhanced 3D Visualization -->
    <div class="advanced-tool">
      <h3>Advanced 3D Molecule Viewer</h3>
      <input type="text" id="moleculeInput" placeholder="Enter molecule (e.g., C1CCCCC1, caffeine)">
      <button onclick="render3DMolecule()">Render Molecule</button>
      <div id="advancedMoleculeViewer" class="molecule-canvas"></div>
      <div>
        <button onclick="rotateMolecule('x')">Rotate X</button>
        <button onclick="rotateMolecule('y')">Rotate Y</button>
        <button onclick="rotateMolecule('z')">Rotate Z</button>
        <button onclick="zoomMolecule(1.2)">Zoom In</button>
        <button onclick="zoomMolecule(0.8)">Zoom Out</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Initialize JSME editor
  let jsmeApplet;
  window.onload = function() {
    jsmeApplet = new JSApplet.JSME("jsme-container", "380px", "300px", {
      options: "oldlook,star,noquery"
    });
  };

  // Get structure from JSME
  function getJSMEStructure() {
    const mol = jsmeApplet.smiles();
    document.getElementById("jsmeOutput").innerHTML = `
      <p><strong>SMILES:</strong> ${mol}</p>
      <p><strong>Molecular Formula:</strong> ${calculateFormula(mol)}</p>
    `;
    return mol;
  }

  // Add to reaction simulator
  function addToSimulator() {
    const mol = getJSMEStructure();
    const formula = calculateFormula(mol);
    const area = document.getElementById("reactionArea");
    const newElement = document.createElement('span');
    newElement.className = 'element-draggable';
    newElement.textContent = formula;
    newElement.dataset.formula = formula;
    area.appendChild(newElement);
  }

  // Calculate molecular formula from SMILES (simplified)
  function calculateFormula(smiles) {
    // In production, use a cheminformatics library like RDKit
    // This is a simplified version for demonstration
    if (smiles.includes('C6H6')) return 'C6H6'; // Benzene
    if (smiles.includes('CCO')) return 'C2H6O'; // Ethanol
    return smiles.replace(/[^A-Za-z0-9]/g, ''); // Very basic cleanup
  }

  // Balance with ChemBalancer API (mock implementation)
  async function balanceWithAPI() {
    const equation = document.getElementById("proUnbalancedEquation").value;
    if (!equation) return;
    
    document.getElementById("apiBalancingSteps").innerHTML = "<p class='loading'>Balancing equation via ChemBalancer API...</p>";
    
    try {
      // In production, you would call the actual API:
      // const response = await fetch('https://api.chembalancer.com/balance', {
      //   method: 'POST',
      //   headers: { 'Content-Type': 'application/json' },
      //   body: JSON.stringify({ equation: equation })
      // });
      // const data = await response.json();
      
      // Mock response for demonstration
      const mockResponse = {
        balanced: "2C6H12O6 + 15O2 → 12CO2 + 12H2O",
        steps: [
          "Count carbon atoms: 6 on left, 1 on right → Add coefficient 6 to CO2",
          "Now count hydrogen: 12 on left, 2 on right → Add coefficient 6 to H2O",
          "Finally balance oxygen: 18 on left, 24 on right → Adjust coefficients"
        ],
        compounds: ["C6H12O6", "O2", "CO2", "H2O"]
      };
      
      document.getElementById("apiBalancedEquation").innerHTML = 
        `Balanced: <strong>${mockResponse.balanced}</strong>`;
      document.getElementById("apiBalancingSteps").innerHTML = 
        "<h4>Balancing Steps:</h4><ol>" + 
        mockResponse.steps.map(step => `<li>${step}</li>`).join('') + 
        "</ol>";
      
      // Visualize all compounds in the equation
      visualizeAllMolecules(mockResponse.compounds);
    } catch (error) {
      document.getElementById("apiBalancingSteps").innerHTML = 
        "<p style='color:red'>Error balancing equation: " + error.message + "</p>";
    }
  }

  // Enhanced 3D molecule visualization with 3DMol.js
  function render3DMolecule() {
    const input = document.getElementById("moleculeInput").value.trim();
    if (!input) return;
    
    const viewer = $3Dmol.createViewer("advancedMoleculeViewer", {
      backgroundColor: 0xffffff
    });
    
    // Try to determine if input is SMILES or common name
    let mol;
    if (input.includes(" ")) {
      // Common name (mock implementation)
      switch(input.toLowerCase()) {
        case "caffeine":
          mol = "CN1C=NC2=C1C(=O)N(C(=O)N2C)C";
          break;
        case "aspirin":
          mol = "CC(=O)OC1=CC=CC=C1C(=O)O";
          break;
        default:
          mol = input;
      }
    } else {
      mol = input;
    }
    
    viewer.addModel(mol, "smi");
    viewer.setStyle({}, {stick: {}});
    viewer.zoomTo();
    viewer.render();
    
    // Store viewer for rotation controls
    window.currentViewer = viewer;
  }

  // Molecule manipulation functions
  function rotateMolecule(axis) {
    if (!window.currentViewer) return;
    const angle = Math.PI / 4; // 45 degrees
    window.currentViewer.rotate(axis === 'x' ? angle : 0, 
                               axis === 'y' ? angle : 0, 
                               axis === 'z' ? angle : 0);
    window.currentViewer.render();
  }

  function zoomMolecule(factor) {
    if (!window.currentViewer) return;
    window.currentViewer.zoom(factor);
    window.currentViewer.render();
  }

  // Visualize multiple molecules
  function visualizeAllMolecules(compounds) {
    const viewer = $3Dmol.createViewer("proMoleculeViewer", {
      backgroundColor: 0xffffff
    });
    
    let xOffset = 0;
    compounds.forEach(compound => {
      viewer.addModel(compound, "smiles", {
        x: xOffset,
        y: 0,
        z: 0
      });
      xOffset += 10;
    });
    
    viewer.setStyle({}, {stick: {}});
    viewer.zoomTo();
    viewer.render();
  }
</script>

<!-- Previous script content remains -->
</body>
</html>
